<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –§–∏–ª—å–º–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #1a1a1a, #000);
            color: #fff;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .movie-card {
            background: rgba(25, 25, 25, 0.95);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cover {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e50914;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .title { font-size: 2em; font-weight: 700; color: #e50914; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .director, .year, .genres { font-size: 1.1em; color: #aaa; margin-bottom: 8px; }
        .rating { font-size: 1.6em; color: #fff; margin-bottom: 25px; font-weight: 700; }
        .rating span { color: #e50914; }
        .button-group button, .actions button {
            display: block;
            width: 100%;
            padding: 14px 0;
            margin-bottom: 10px;
            background: #e50914;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s ease;
            letter-spacing: 0.5px;
        }
        .button-group button:hover, .actions button:hover { background: #f40a1c; }
        .actions button { background: #3a3a3a; margin-top: 15px; }
        .actions button:hover { background: #555; }
        .back-button {
            margin-top: 30px;
            padding: 12px 25px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .back-button:hover { background: #555; }
        .icon { margin-right: 8px; }
    </style>
</head>
<body>
    <div class="movie-card">
        <img id="cover" class="cover" src="" alt="Movie Cover">
        <div id="title" class="title"></div>
        <div id="director" class="director"><span class="icon">üé¨</span>–†–µ–∂–∏—Å—Å–µ—Ä: <span></span></div>
        <div id="year" class="year"><span class="icon">üìÖ</span>–ì–æ–¥: <span></span></div>
        <div id="genres" class="genres"><span class="icon">üé≠</span>–ñ–∞–Ω—Ä—ã: <span></span></div>
        <div id="rating" class="rating">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: <span>N/A</span> ‚≠êÔ∏è</div>

        <div class="button-group">
            <button onclick="rateMovie()"><span class="icon">‚≠êÔ∏è</span> –û–¶–ï–ù–ò–¢–¨ (RZT –°–¢–ò–õ–¨)</button>
            <button onclick="showDirector()"><span class="icon">üé•</span> –ö–ê–†–¢–û–ß–ö–ê –†–ï–ñ–ò–°–°–ï–†–ê</button>
        </div>
        <div class="actions">
             <button id="watchlistButton" onclick="toggleWatchlist()"><span class="icon">‚ù§Ô∏è</span> –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
        </div>
    </div>
    <button class="back-button" onclick="goBack()">–ó–ê–ö–†–´–¢–¨</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const webAppBaseUrl = new URL(window.location.href).origin + new URL(window.location.href).pathname.split('/').slice(0, -1).join('/') + '/';

        function getUrlParams() {
            const params = {};
            new URLSearchParams(window.location.search).forEach((value, key) => {
                params[key] = decodeURIComponent(value);
            });
            return params;
        }

        const params = getUrlParams();
        const mid = params.mid;
        const movieTitle = params.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª—å–º';
        const movieDirector = params.director || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏—Å—Å–µ—Ä';
        const movieCover = params.cover_url || 'https://via.placeholder.com/450x600/303030/FFFFFF?text=NO+COVER';
        const movieYear = params.year || 'N/A';
        const movieGenres = params.genres || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const movieRating = params.avg_rating ? parseFloat(params.avg_rating).toFixed(1) : '0.0';

        document.getElementById('title').innerText = movieTitle;
        document.querySelector('#director span').innerText = movieDirector;
        document.querySelector('#year span').innerText = movieYear;
        document.querySelector('#genres span').innerText = movieGenres.split(',').join(', ');
        document.querySelector('#rating span').innerText = movieRating;
        document.getElementById('cover').src = movieCover;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        function rateMovie() {
            if (mid) {
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –æ—Ü–µ–Ω–∫–∏
                const rateUrl = `${webAppBaseUrl}index.html?mid=${mid}&title=${encodeURIComponent(movieTitle)}&comment=${encodeURIComponent(params.comment || '')}&c1=${params.c1 || 5}&c2=${params.c2 || 5}&c3=${params.c3 || 5}&c4=${params.c4 || 5}`;
                tg.openWebApp(rateUrl);
            } else {
                tg.showAlert('–û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ—Ü–µ–Ω–∫–∏.');
            }
        }

        function showDirector() {
            if (movieDirector) {
                 // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∂–∏—Å—Å–µ—Ä–∞, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–≥–æ –∏–º—è
                 // –°–∞–º director_display.html –∑–∞–ø—Ä–æ—Å–∏—Ç —É
–±–æ—Ç–∞ –µ–≥–æ —Ñ–∏–ª—å–º—ã
                tg.openWebApp(`${webAppBaseUrl}director_display.html?director_name=${encodeURIComponent(movieDirector)}`);
            } else {
                tg.showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∂–∏—Å—Å–µ—Ä–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π" ---
        const watchlistButton = document.getElementById('watchlistButton');
        const watchlistText = watchlistButton.querySelector('span:last-child');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —Ñ–∏–ª—å–º –≤ —Å–ø–∏—Å–æ–∫ (–ø–∞—Ä–∞–º–µ—Ç—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ –±–æ—Ç–∞)
        const isInWatchlist = params.in_watchlist === 'true'; // –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ 'true'/'false'
        updateWatchlistButton(isInWatchlist);

        function toggleWatchlist() {
             // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É —á–µ—Ä–µ–∑ sendData, —á—Ç–æ–±—ã –æ–Ω –æ–±–Ω–æ–≤–∏–ª –ë–î
             // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å action (add/remove) –∏ movie_id
             const action = isInWatchlist ? 'remove' : 'add';
             tg.sendData(JSON.stringify({ action: 'watchlist', movie_id: mid, action_type: action }));
             tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        }

        function updateWatchlistButton(isIn) {
            if (isIn) {
                watchlistButton.style.background = '#3a3a3a'; // –°–µ—Ä—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ
                watchlistButton.style.marginTop = '15px';
                watchlistButton.querySelector('.icon').innerText = '‚úÖ'; // –ì–∞–ª–æ—á–∫–∞
                watchlistText.innerText = '–í —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π';
            } else {
                watchlistButton.style.background = '#e50914'; // –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ
                watchlistButton.style.marginTop = '15px';
                watchlistButton.querySelector('.icon').innerText = '‚ù§Ô∏è'; // –°–µ—Ä–¥—Ü–µ
                watchlistText.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫';
            }
        }

        function goBack() {
            tg.close();
        }
    </script>
</body>
</html>
